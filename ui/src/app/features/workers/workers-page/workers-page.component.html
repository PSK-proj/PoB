<div class="page" *ngIf="vm$ | async as vm">
    <mat-card class="card">
        <mat-card-title>Workers (management)</mat-card-title>
        <mat-card-subtitle>
            Mode: <b>{{ vm.mode }}</b>
            • selected: <b>{{ vm.selectedCount }}</b>/<b>{{ vm.allCount }}</b>
        </mat-card-subtitle>

        <mat-progress-bar *ngIf="vm.busy" mode="indeterminate"></mat-progress-bar>

        <div class="toolbar">
            <mat-form-field appearance="outline">
                <mat-label>Search</mat-label>
                <input matInput [formControl]="searchCtrl" placeholder="worker id or url" />
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Filter</mat-label>
                <mat-select [formControl]="statusFilterCtrl">
                    <mat-option value="all">All</mat-option>
                    <mat-option value="online">Online</mat-option>
                    <mat-option value="offline">Offline</mat-option>
                    <mat-option value="error">Has error</mat-option>
                </mat-select>
            </mat-form-field>

            <div class="bulk">
                <div class="mode-switch" [matTooltip]="modeTooltip(vm.mode)">
                    <span class="muted small">Weights</span>
                    <mat-button-toggle-group [value]="vm.mode" [disabled]="vm.busy"
                        (change)="onWeightModeChange($event.value, vm.mode)">
                        <mat-button-toggle value="manual">Manual</mat-button-toggle>
                        <mat-button-toggle value="auto">Auto</mat-button-toggle>
                    </mat-button-toggle-group>
                </div>

                <button mat-stroked-button type="button" [disabled]="!vm.canBulk"
                    (click)="bulkResetMetrics(getSelectedIds())">
                    <mat-icon>restart_alt</mat-icon>
                    Reset metrics
                </button>

                <button mat-stroked-button color="warn" type="button" [disabled]="!vm.canBulk"
                    (click)="bulkClearFaults(getSelectedIds())">
                    <mat-icon>delete_sweep</mat-icon>
                    Clear faults
                </button>

                <button mat-button type="button" [disabled]="vm.selectedCount === 0" (click)="clearSelection()">
                    Clear selection
                </button>
            </div>
        </div>
    </mat-card>

    <mat-card class="card">
        <div class="table-wrap">
            <table mat-table [dataSource]="vm.workers" [trackBy]="trackByWorkerId" class="mat-elevation-z1">
                <ng-container matColumnDef="select">
                    <th mat-header-cell *matHeaderCellDef>
                        <mat-checkbox [checked]="vm.allSelected"
                            [indeterminate]="vm.selectedCount > 0 && !vm.allSelected"
                            (change)="toggleAll(vm.workers, $event.checked)"></mat-checkbox>
                    </th>
                    <td mat-cell *matCellDef="let w">
                        <mat-checkbox [checked]="isSelected(w.id)"
                            (change)="toggleOne(w.id, $event.checked)"></mat-checkbox>
                    </td>
                </ng-container>

                <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef>Worker</th>
                    <td mat-cell *matCellDef="let w">
                        <a [routerLink]="['/workers', w.id]">{{ w.id }}</a>
                        <div class="muted small">{{ w.url }}</div>
                    </td>
                </ng-container>

                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let w">
                        <mat-chip-set>
                            <mat-chip class="status-chip" [class.status-chip--online]="w.online"
                                [class.status-chip--offline]="!w.online">
                                {{ w.online ? 'online' : 'offline' }}
                            </mat-chip>
                        </mat-chip-set>
                    </td>
                </ng-container>

                <ng-container matColumnDef="effWeight">
                    <th mat-header-cell *matHeaderCellDef>weights</th>
                    <td mat-cell *matCellDef="let w">
                        <div><span class="muted">eff</span> <b>{{ w.effective_weight }}</b></div>
                        <div class="small muted">
                            rep {{ w.reported_weight }}
                            • man {{ w.manual_weight ?? '—' }}
                            • auto {{ w.auto_weight ?? '—' }}
                        </div>
                    </td>
                </ng-container>

                <ng-container matColumnDef="assignedPct">
                    <th mat-header-cell *matHeaderCellDef>assigned %</th>
                    <td mat-cell *matCellDef="let w">{{ w.assigned_pct | number:'1.0-2' }}%</td>
                </ng-container>

                <ng-container matColumnDef="okFail">
                    <th mat-header-cell *matHeaderCellDef>ok/fail</th>
                    <td mat-cell *matCellDef="let w">{{ w.ok }} / {{ w.fail }}</td>
                </ng-container>

                <ng-container matColumnDef="lat">
                    <th mat-header-cell *matHeaderCellDef>avg ms</th>
                    <td mat-cell *matCellDef="let w">{{ w.avg_latency_ms | number:'1.0-2' }}</td>
                </ng-container>

                <ng-container matColumnDef="lastSeen">
                    <th mat-header-cell *matHeaderCellDef>last seen</th>
                    <td mat-cell *matCellDef="let w">
                        <ng-container *ngIf="w.last_seen; else na">
                            {{ (w.last_seen * 1000) | date:'HH:mm:ss' }}
                        </ng-container>
                        <ng-template #na>—</ng-template>
                    </td>
                </ng-container>

                <ng-container matColumnDef="err">
                    <th mat-header-cell *matHeaderCellDef>last error</th>
                    <td mat-cell *matCellDef="let w">{{ w.last_error ?? '—' }}</td>
                </ng-container>

                <ng-container matColumnDef="manualWeightActions">
                    <th mat-header-cell *matHeaderCellDef>manual weight</th>
                    <td mat-cell *matCellDef="let w">
                        <div class="manual-weight">
                            <mat-form-field appearance="outline" class="mw-field">
                                <mat-label>weight</mat-label>
                                <input matInput type="number" min="1" max="1000" [formControl]="getManualWeightCtrl(w)"
                                    [matTooltip]="manualWeightTooltip(vm.mode)" (focus)="onManualWeightFocus(w.id)"
                                    (blur)="onManualWeightBlur(w.id)" />
                            </mat-form-field>

                            <button mat-stroked-button type="button" [disabled]="manualWeightDisabled(vm.mode, vm.busy)"
                                (click)="setManualWeight(w, vm.mode)">
                                Save
                            </button>

                            <button mat-button type="button" [disabled]="manualWeightDisabled(vm.mode, vm.busy)"
                                (click)="clearManualWeight(w, vm.mode)">
                                Clear
                            </button>
                        </div>
                    </td>
                </ng-container>

                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>actions</th>
                    <td mat-cell *matCellDef="let w">
                        <button mat-stroked-button type="button" [routerLink]="['/workers', w.id]">
                            Open details
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="cols"></tr>
                <tr mat-row *matRowDef="let row; columns: cols;"></tr>
            </table>
        </div>
    </mat-card>
</div>
